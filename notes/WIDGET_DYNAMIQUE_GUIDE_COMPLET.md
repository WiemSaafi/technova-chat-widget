# üìñ GUIDE COMPLET : WIDGET CHAT DYNAMIQUE

## üéØ **OBJECTIF R√âALIS√â**

Transformer un widget chat statique en syst√®me **100% dynamique** qui s'adapte automatiquement selon le mod√®le choisi.

---

## üìÅ **FICHIERS MODIFI√âS**

### **1. `widget-embed.js`** ‚Üê Fichier principal modifi√©
- **Localisation :** Racine du projet
- **R√¥le :** Widget frontend qui s'int√®gre sur n'importe quel site
- **Modifications :** Interface dynamique + API calls

### **2. `backend/server.js`** ‚Üê D√©j√† pr√™t (API existante)
- **R√¥le :** API backend qui g√©n√®re les infos dynamiques
- **Route utilis√©e :** `/api/model-info/:modelName`

---

## üîß **ARCHITECTURE DYNAMIQUE**

### **AVANT (Statique) :**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ widget-embed.js ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚ùå HTML cod√©    ‚îÇ ‚Üê "TechNova Assistant" fixe
‚îÇ ‚ùå Questions    ‚îÇ ‚Üê Questions TechNova fixes  
‚îÇ ‚ùå Syst√®me msg  ‚îÇ ‚Üê "Tu es TechNova..." fixe
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **APR√àS (Dynamique) :**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    API Call    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ widget-embed.js ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ /api/model-info/ ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚úÖ HTML g√©n√©r√© ‚îÇ ‚Üê Nom dynamique ‚îÇ ‚úÖ JSON Response ‚îÇ
‚îÇ ‚úÖ Questions    ‚îÇ ‚Üê Selon mod√®le  ‚îÇ ‚úÖ assistantName ‚îÇ
‚îÇ ‚úÖ Syst√®me msg  ‚îÇ ‚Üê Message adapt√©‚îÇ ‚úÖ quickQuestions‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ ‚úÖ systemMessage ‚îÇ
                                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìù **MODIFICATIONS D√âTAILL√âES**

### **üîÑ √âTAPE 1 : Ajout variable globale**

**Fichier :** `widget-embed.js`  
**Ligne :** 456  
**Code ajout√© :**
```javascript
// üì® Variables globales pour le chat
let isLoading = false;
let messages = [];
let currentModelInfo = null; // ‚Üê NOUVEAU: Stocker les infos du mod√®le
```

**üìã Explication :**
- `currentModelInfo` stocke les donn√©es re√ßues de l'API
- Utilis√©e dans `sendToAPI()` pour le message syst√®me dynamique

---

### **üîÑ √âTAPE 2 : Fonction r√©cup√©ration API**

**Fichier :** `widget-embed.js`  
**Ligne :** 394-424  
**Code ajout√© :**
```javascript
// üîÑ R√©cup√©ration des infos dynamiques du mod√®le depuis l'API
const getModelInfo = async (modelName) => {
    try {
        console.log(`üîç R√©cup√©ration des infos pour le mod√®le: ${modelName}`);
        
        const response = await fetch(`${config.backendUrl}/api/model-info/${modelName}`);
        
        if (!response.ok) {
            throw new Error(`Erreur API: ${response.status}`);
        }
        
        const modelInfo = await response.json();
        console.log('‚úÖ Infos mod√®le re√ßues:', modelInfo);
        
        return modelInfo;
    } catch (error) {
        console.warn('‚ö†Ô∏è Erreur r√©cup√©ration infos mod√®le:', error);
        
        // Fallback - Configuration par d√©faut si l'API ne r√©pond pas
        return {
            assistantName: `${config.model.charAt(0).toUpperCase() + config.model.slice(1)} Assistant`,
            description: `Bonjour ! Je suis votre assistant ${config.model}. Comment puis-je vous aider ?`,
            quickQuestions: [
                { icon: '‚ùì', text: 'Que peux-tu faire ?', question: 'Que peux-tu faire comme assistant IA ?' },
                { icon: 'üí°', text: 'Aide-moi', question: 'Comment peux-tu m\'aider ?' },
                { icon: 'üîß', text: 'Tes capacit√©s', question: 'Quelles sont tes principales capacit√©s ?' }
            ]
        };
    }
};
```

**üìã Explication :**
- **Appelle :** `/api/model-info/cyberaide` (ou autre mod√®le)
- **Re√ßoit :** JSON avec nom, description, questions, message syst√®me
- **Fallback :** Configuration g√©n√©rique si API non disponible
- **Logs :** Pour debugging facile

---

### **üîÑ √âTAPE 3 : Interface dynamique asynchrone**

**Fichier :** `widget-embed.js`  
**Ligne :** 426-490  
**Code modifi√© :**

```javascript
// üé® Cr√©ation de l'interface de chat DYNAMIQUE
const createChatInterface = async () => {
    const chatDiv = document.createElement('div');
    chatDiv.className = `technova-embed-iframe technova-embed-iframe-${config.position} technova-embed-hidden`;
    
    // üîÑ NOUVEAU : R√©cup√©rer les infos dynamiques du mod√®le
    const modelInfo = await getModelInfo(config.model);
    
    // üíæ NOUVEAU : Stocker les infos pour utilisation dans sendToAPI
    currentModelInfo = modelInfo;
    
    // üéØ Construction des questions rapides dynamiques
    const quickQuestionsHTML = modelInfo.quickQuestions.map(q => `
        <button class="technova-quick-question" onclick="sendQuickQuestion(this)" data-question="${q.question}">
            ${q.icon} ${q.text}
        </button>
    `).join('');
    
    chatDiv.innerHTML = `
        <div class="technova-chat-header">
            <h3>üí¨ ${modelInfo.assistantName}</h3>     ‚Üê DYNAMIQUE !
            <button class="technova-close-btn">√ó</button>
        </div>
        
        <div class="technova-chat-body">
            <div class="technova-chat-messages" id="technova-messages">
                <div class="technova-welcome-message">
                    <h4>üëã Bienvenue !</h4>
                    <p>${modelInfo.description}</p>          ‚Üê DYNAMIQUE !
                </div>
            </div>
            
            <div class="technova-quick-questions">
                <h4>Questions rapides</h4>
                <div class="technova-questions-grid">
                    ${quickQuestionsHTML}                   ‚Üê DYNAMIQUE !
                </div>
            </div>
            
            <!-- ... reste de l'interface ... -->
        </div>
    `;

    return chatDiv;
};
```

**üìã Explication :**
- **Avant :** HTML statique avec valeurs cod√©es en dur
- **Apr√®s :** HTML g√©n√©r√© avec `${modelInfo.xxx}` dynamique
- **Stockage :** `currentModelInfo = modelInfo` pour usage ult√©rieur
- **Questions :** `.map()` g√©n√®re les boutons depuis l'API

---

### **üîÑ √âTAPE 4 : Fonctions asynchrones**

**Fichier :** `widget-embed.js`  
**Lignes :** 360 & 492  
**Code modifi√© :**

```javascript
// üèóÔ∏è Cr√©ation du conteneur principal - VERSION DYNAMIQUE ASYNCHRONE
const createWidget = async () => {
    // ... code existant ...
    
    // 2. Cr√©e l'interface de chat DYNAMIQUE (attendre la r√©cup√©ration des infos)
    console.log('üîÑ Cr√©ation de l\'interface dynamique...');
    const chatInterface = await createChatInterface();  // ‚Üê await ajout√©
    
    // ... reste du code ...
};

// üöÄ Initialisation DYNAMIQUE ASYNCHRONE
const init = async () => {
    // ... v√©rifications DOM ...
    
    // ‚è≥ NOUVEAU : Attendre la cr√©ation compl√®te du widget (avec infos API)
    const widget = await createWidget();  // ‚Üê await ajout√©
    document.body.appendChild(widget);
    
    console.log('‚úÖ Widget dynamique initialis√© avec succ√®s pour le mod√®le:', config.model);
};
```

**üìã Explication :**
- **Ajout :** `async/await` pour g√©rer les appels API
- **S√©quence :** Attendre l'API avant de cr√©er l'interface
- **Logs :** Confirmation du mod√®le charg√©

---

### **üîÑ √âTAPE 5 : Message syst√®me dynamique**

**Fichier :** `widget-embed.js`  
**Ligne :** 663-682  
**Code modifi√© :**

```javascript
// üöÄ Envoyer √† l'API backend
const sendToAPI = async (userMessage) => {
    try {
        console.log('üîó Envoi vers:', `${config.backendUrl}/api/chat`);
        
        // üîÑ NOUVEAU : Message syst√®me dynamique selon le mod√®le
        const systemMessage = currentModelInfo && currentModelInfo.systemMessage 
            ? currentModelInfo.systemMessage 
            : `Tu es ${config.model}, un assistant IA. Tu peux aider avec diverses t√¢ches et questions. R√©ponds de mani√®re utile et pr√©cise.`;
        
        console.log('üéØ Message syst√®me utilis√©:', systemMessage.substring(0, 50) + '...');
        
        const response = await fetch(`${config.backendUrl}/api/chat`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: config.model,
                messages: [
                    {
                        role: 'system',
                        content: systemMessage  // ‚Üê NOUVEAU : Dynamique !
                    },
                    // ... reste des messages ...
                ],
                max_tokens: 1500,
                temperature: 0.7,
                stream: false
            })
        });
        
        // ... traitement r√©ponse ...
    } catch (error) {
        // ... gestion erreurs ...
    }
};
```

**üìã Explication :**
- **Avant :** `'Tu es TechNova Assistant...'` fixe
- **Apr√®s :** Utilise `currentModelInfo.systemMessage` de l'API
- **Fallback :** Message g√©n√©rique si pas de systemMessage
- **Logs :** Debug du message syst√®me utilis√©

---

## üöÄ **FONCTIONNEMENT √âTAPE PAR √âTAPE**

### **1. Chargement de la page :**
```javascript
init() // Fonction asynchrone appel√©e
```

### **2. Cr√©ation du widget :**
```javascript
const widget = await createWidget()  // Attend la cr√©ation compl√®te
```

### **3. Cr√©ation de l'interface :**
```javascript
const chatInterface = await createChatInterface()  // Appel API √† l'int√©rieur
```

### **4. Appel API dynamique :**
```javascript
const modelInfo = await getModelInfo('cyberaide')
// GET /api/model-info/cyberaide
```

### **5. R√©ponse API :**
```json
{
  "assistantName": "Cyberaide Assistant",
  "description": "Assistant sp√©cialis√© cybers√©curit√©...",
  "quickQuestions": [
    {"icon": "üõ°Ô∏è", "text": "S√©curit√©", "question": "..."},
    {"icon": "üîê", "text": "Attaques", "question": "..."}
  ],
  "systemMessage": "Tu es cyberaide, expert cybers√©curit√©..."
}
```

### **6. G√©n√©ration HTML :**
```javascript
chatDiv.innerHTML = `<h3>üí¨ ${modelInfo.assistantName}</h3>`
// R√©sultat: <h3>üí¨ Cyberaide Assistant</h3>
```

### **7. Stockage des infos :**
```javascript
currentModelInfo = modelInfo  // Pour usage dans sendToAPI
```

### **8. Envoi de message :**
```javascript
const systemMessage = currentModelInfo.systemMessage
// Utilise: "Tu es cyberaide, expert cybers√©curit√©..."
```

---

## üîÑ **COMMENT CHANGER DE MOD√àLE**

### **Configuration actuelle :**
```javascript
// Ligne 9 dans widget-embed.js
model: 'cyberaide',
```

### **Pour changer vers un autre mod√®le :**
```javascript
// Exemple pour mod√®le marketing
model: 'marketing',
```

### **R√©sultat automatique :**
1. **API appel√©e :** `/api/model-info/marketing`
2. **Interface g√©n√©r√©e :** "Marketing Assistant"
3. **Questions :** Commerce, vente, produits
4. **R√©ponses IA :** Contexte marketing

### **Aucune autre modification n√©cessaire !**

---

## üîç **DEBUGGING / TROUBLESHOOTING**

### **Console Logs √† v√©rifier :**
```javascript
üöÄ TechNova Widget Embed charg√© avec la configuration: {model: "cyberaide"}
üéØ Initialisation du widget dynamique...
üîÑ Cr√©ation de l'interface dynamique...
üîç R√©cup√©ration des infos pour le mod√®le: cyberaide
‚úÖ Infos mod√®le re√ßues: {assistantName: "Cyberaide Assistant", ...}
‚úÖ Widget dynamique initialis√© avec succ√®s pour le mod√®le: cyberaide
üéØ Message syst√®me utilis√©: Tu es cyberaide, un assistant IA sp√©cialis√©...
```

### **Erreurs possibles :**
1. **API non disponible :** Fallback activ√© automatiquement
2. **Mod√®le inexistant :** Configuration g√©n√©rique utilis√©e
3. **Cache navigateur :** Faire Ctrl+F5

---

## üìä **AVANTAGES DU SYST√àME DYNAMIQUE**

### **‚úÖ Pour le d√©veloppeur :**
- **1 seul changement** ‚Üí Tout s'adapte
- **Pas de maintenance** des textes/questions
- **Extensible facilement** ‚Üí Nouveau mod√®le = Ajout API

### **‚úÖ Pour le client :**
- **Exp√©rience coh√©rente** ‚Üí Interface + IA adapt√©es
- **Sp√©cialisation** ‚Üí Chaque mod√®le a son expertise
- **Professional** ‚Üí Pas de confusion TechNova/CyberAide

### **‚úÖ Pour l'√©volutivit√© :**
- **Ajouter mod√®le** ‚Üí Juste l'ajouter au backend
- **Personnalisation** ‚Üí Questions/styles par mod√®le
- **Multi-clients** ‚Üí Chaque client son mod√®le

---

## üéØ **R√âSUM√â TECHNIQUE**

**Le widget est maintenant 100% dynamique gr√¢ce √† :**

1. **API Backend** ‚Üí Fournit les donn√©es selon le mod√®le
2. **Appel asynchrone** ‚Üí R√©cup√®re les infos au chargement  
3. **HTML g√©n√©r√©** ‚Üí Plus de valeurs cod√©es en dur
4. **Message syst√®me** ‚Üí IA r√©pond selon le contexte
5. **Fallback intelligent** ‚Üí Fonctionne m√™me sans API

**UN CHANGEMENT DE MOD√àLE = TOUT S'ADAPTE AUTOMATIQUEMENT !**
